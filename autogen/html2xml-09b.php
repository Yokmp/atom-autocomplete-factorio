<?php
/* Copyright (C) 2008 Alain COUTHURES
//
// This program is free software; you can redistribute it and/or
// modify it under the terms of the GNU General Public License
// as published by the Free Software Foundation; either version 2
// of the License, or (at your option) any later version.
//
// This program is distributed in the hope that it will be useful,
// but WITHOUT ANY WARRANTY; without even the implied warranty of
// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
// GNU General Public License for more details.
//
// You should have received a copy of the GNU General Public License
// along with this program; if not, write to the Free Software
// Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.

Added option to replace entities with one Whitespace
see Line 656   ~Yokmp 01.09.17
Added percentage done at Line 322		~Yokmp 27.11.18
*/
$namedentities["AElig"] = 198;
$namedentities["Aacute"] = 193;
$namedentities["Acirc"] = 194;
$namedentities["Agrave"] = 192;
$namedentities["Alpha"] = 913;
$namedentities["Aring"] = 197;
$namedentities["Atilde"] = 195;
$namedentities["Auml"] = 196;
$namedentities["Beta"] = 914;
$namedentities["Ccedil"] = 199;
$namedentities["Chi"] = 935;
$namedentities["Dagger"] = 8225;
$namedentities["Delta"] = 916;
$namedentities["ETH"] = 208;
$namedentities["Eacute"] = 201;
$namedentities["Ecirc"] = 202;
$namedentities["Egrave"] = 200;
$namedentities["Epsilon"] = 917;
$namedentities["Eta"] = 919;
$namedentities["Euml"] = 203;
$namedentities["Gamma"] = 915;
$namedentities["Iacute"] = 205;
$namedentities["Icirc"] = 206;
$namedentities["Igrave"] = 204;
$namedentities["Iota"] = 921;
$namedentities["Iuml"] = 207;
$namedentities["Kappa"] = 922;
$namedentities["Lambda"] = 923;
$namedentities["Mu"] = 924;
$namedentities["Ntilde"] = 209;
$namedentities["Nu"] = 925;
$namedentities["OElig"] = 338;
$namedentities["Oacute"] = 211;
$namedentities["Ocirc"] = 212;
$namedentities["Ograve"] = 210;
$namedentities["Omega"] = 937;
$namedentities["Omicron"] = 927;
$namedentities["Oslash"] = 216;
$namedentities["Otilde"] = 213;
$namedentities["Ouml"] = 214;
$namedentities["Phi"] = 934;
$namedentities["Pi"] = 928;
$namedentities["Prime"] = 8243;
$namedentities["Psi"] = 936;
$namedentities["Rho"] = 929;
$namedentities["Scaron"] = 352;
$namedentities["Sigma"] = 931;
$namedentities["THORN"] = 222;
$namedentities["Tau"] = 932;
$namedentities["Theta"] = 920;
$namedentities["Uacute"] = 218;
$namedentities["Ucirc"] = 219;
$namedentities["Ugrave"] = 217;
$namedentities["Upsilon"] = 933;
$namedentities["Uuml"] = 220;
$namedentities["Xi"] = 926;
$namedentities["Yacute"] = 221;
$namedentities["Yuml"] = 376;
$namedentities["Zeta"] = 918;
$namedentities["aacute"] = 225;
$namedentities["acirc"] = 226;
$namedentities["acute"] = 180;
$namedentities["aelig"] = 230;
$namedentities["agrave"] = 224;
$namedentities["alpha"] = 945;
$namedentities["and"] = 8743;
$namedentities["ang"] = 8736;
$namedentities["aring"] = 229;
$namedentities["asymp"] = 8776;
$namedentities["atilde"] = 227;
$namedentities["auml"] = 228;
$namedentities["bdquo"] = 8222;
$namedentities["beta"] = 946;
$namedentities["brvbar"] = 166;
$namedentities["bull"] = 8226;
$namedentities["cap"] = 8745;
$namedentities["ccedil"] = 231;
$namedentities["cedil"] = 184;
$namedentities["cent"] = 162;
$namedentities["chi"] = 967;
$namedentities["circ"] = 710;
$namedentities["clubs"] = 9827;
$namedentities["cong"] = 8773;
$namedentities["copy"] = 169;
$namedentities["crarr"] = 8629;
$namedentities["cup"] = 8746;
$namedentities["curren"] = 164;
$namedentities["dagger"] = 8224;
$namedentities["darr"] = 8595;
$namedentities["deg"] = 176;
$namedentities["delta"] = 948;
$namedentities["diams"] = 9830;
$namedentities["divide"] = 247;
$namedentities["eacute"] = 233;
$namedentities["ecirc"] = 234;
$namedentities["egrave"] = 232;
$namedentities["empty"] = 8709;
$namedentities["emsp"] = 8195;
$namedentities["ensp"] = 8194;
$namedentities["epsilon"] = 949;
$namedentities["equiv"] = 8801;
$namedentities["eta"] = 951;
$namedentities["eth"] = 240;
$namedentities["euml"] = 235;
$namedentities["euro"] = 8364;
$namedentities["exists"] = 8707;
$namedentities["fnof"] = 402;
$namedentities["forall"] = 8704;
$namedentities["frac12"] = 189;
$namedentities["frac14"] = 188;
$namedentities["frac34"] = 190;
$namedentities["gamma"] = 947;
$namedentities["ge"] = 8805;
$namedentities["harr"] = 8596;
$namedentities["hearts"] = 9829;
$namedentities["hellip"] = 8230;
$namedentities["iacute"] = 237;
$namedentities["icirc"] = 238;
$namedentities["iexcl"] = 161;
$namedentities["igrave"] = 236;
$namedentities["infin"] = 8734;
$namedentities["int"] = 8747;
$namedentities["iota"] = 953;
$namedentities["iquest"] = 191;
$namedentities["isin"] = 8712;
$namedentities["iuml"] = 239;
$namedentities["kappa"] = 954;
$namedentities["lambda"] = 923;
$namedentities["laquo"] = 171;
$namedentities["larr"] = 8592;
$namedentities["lceil"] = 8968;
$namedentities["ldquo"] = 8220;
$namedentities["le"] = 8804;
$namedentities["lfloor"] = 8970;
$namedentities["lowast"] = 8727;
$namedentities["loz"] = 9674;
$namedentities["lrm"] = 8206;
$namedentities["lsaquo"] = 8249;
$namedentities["lsquo"] = 8216;
$namedentities["macr"] = 175;
$namedentities["mdash"] = 8212;
$namedentities["micro"] = 181;
$namedentities["middot"] = 183;
$namedentities["minus"] = 8722;
$namedentities["mu"] = 956;
$namedentities["nabla"] = 8711;
$namedentities["nbsp"] = 160;
$namedentities["ndash"] = 8211;
$namedentities["ne"] = 8800;
$namedentities["ni"] = 8715;
$namedentities["not"] = 172;
$namedentities["notin"] = 8713;
$namedentities["nsub"] = 8836;
$namedentities["ntilde"] = 241;
$namedentities["nu"] = 925;
$namedentities["oacute"] = 243;
$namedentities["ocirc"] = 244;
$namedentities["oelig"] = 339;
$namedentities["ograve"] = 242;
$namedentities["oline"] = 8254;
$namedentities["omega"] = 969;
$namedentities["omicron"] = 959;
$namedentities["oplus"] = 8853;
$namedentities["or"] = 8744;
$namedentities["ordf"] = 170;
$namedentities["ordm"] = 186;
$namedentities["oslash"] = 248;
$namedentities["otilde"] = 245;
$namedentities["otimes"] = 8855;
$namedentities["ouml"] = 246;
$namedentities["para"] = 182;
$namedentities["part"] = 8706;
$namedentities["permil"] = 8240;
$namedentities["perp"] = 8869;
$namedentities["phi"] = 966;
$namedentities["pi"] = 960;
$namedentities["piv"] = 982;
$namedentities["plusmn"] = 177;
$namedentities["pound"] = 163;
$namedentities["prime"] = 8242;
$namedentities["prod"] = 8719;
$namedentities["prop"] = 8733;
$namedentities["psi"] = 968;
$namedentities["radic"] = 8730;
$namedentities["raquo"] = 187;
$namedentities["rarr"] = 8594;
$namedentities["rceil"] = 8969;
$namedentities["rdquo"] = 8221;
$namedentities["reg"] = 174;
$namedentities["rfloor"] = 8971;
$namedentities["rho"] = 961;
$namedentities["rlm"] = 8207;
$namedentities["rsaquo"] = 8250;
$namedentities["rsquo"] = 8217;
$namedentities["sbquo"] = 8218;
$namedentities["scaron"] = 353;
$namedentities["sdot"] = 8901;
$namedentities["sect"] = 167;
$namedentities["shy"] = 173;
$namedentities["sigma"] = 963;
$namedentities["sigmaf"] = 962;
$namedentities["sim"] = 8764;
$namedentities["spades"] = 9824;
$namedentities["sub"] = 8834;
$namedentities["sube"] = 8838;
$namedentities["sum"] = 8721;
$namedentities["sup"] = 8835;
$namedentities["sup1"] = 185;
$namedentities["sup3"] = 179;
$namedentities["supe"] = 8839;
$namedentities["szlig"] = 223;
$namedentities["tau"] = 964;
$namedentities["there4"] = 8756;
$namedentities["theta"] = 952;
$namedentities["thetasym"] = 977;
$namedentities["thinsp"] = 8201;
$namedentities["thorn"] = 254;
$namedentities["tilde"] = 732;
$namedentities["times"] = 215;
$namedentities["trade"] = 8482;
$namedentities["uacute"] = 250;
$namedentities["uarr"] = 8593;
$namedentities["ucirc"] = 251;
$namedentities["ugrave"] = 249;
$namedentities["uml"] = 168;
$namedentities["up2"] = 178;
$namedentities["upsih"] = 978;
$namedentities["upsilon"] = 965;
$namedentities["uuml"] = 252;
$namedentities["xi"] = 958;
$namedentities["yacute"] = 253;
$namedentities["yen"] = 165;
$namedentities["yuml"] = 255;
$namedentities["zeta"] = 950;
$namedentities["zwj"] = 8205;
$namedentities["zwnj"] = 8204;
$emptytags = array("area", "base", "basefont", "br", "col", "frame", "hr", "img", "input", "isindex", "link", "meta", "param");
$autoclosetags["basefont"] = array("basefont");
$autoclosetags["colgroup"] = array("colgroup");
$autoclosetags["dd"] = array("colgroup");
$autoclosetags["dt"] = array("dt");
$autoclosetags["li"] = array("li");
$autoclosetags["p"] = array("p");
$autoclosetags["thead"] = array("tbody", "tfoot");
$autoclosetags["tbody"] = array("thead", "tfoot");
$autoclosetags["tfoot"] = array("thead", "tbody");
$autoclosetags["th"] = array("td");
$autoclosetags["td"] = array("th", "td");
$autoclosetags["tr"] = array("tr");
$autoclosekeys = array("basefont", "colgroup", "dd", "dt", "li", "p", "thead", "tbody", "tfoot", "th", "td", "tr");
define("states_text", 0);
define("states_tag", 1);
define("states_endtag", 2);
define("states_attrtext", 3);
define("states_script", 4);
define("states_endscript", 5);
define("states_specialtag", 6);
define("states_comment", 7);
define("states_skipcdata", 8);
define("states_entity", 9);
define("states_namedentity", 10);
define("states_numericentity", 11);
define("states_hexaentity", 12);
define("states_tillgt", 13);
define("states_tillquote", 14);
define("states_tillinst", 15);
define("states_andgt", 16);

function html2xml($s, $replace_entities = false) {

	if (isset($argv[1]) && $argv[1] == true) {
		$replace_entities = true;
	}
	global $namedentities, $emptytags, $autoclosetags, $autoclosekeys;
	$r2 = "";
	$r = "";
	$limit = strlen($s);
	$state = states_text;
	$prevstate = $state;
	$opentags = array();
	$name = "";
	$tagname = "";
	$attrname = "";
	$attrs = "";
	$attrnames = array();
	$entvalue = 0;
	$attrdelim = "\"";
	$attrvalue = "";
	$cs = "";
	$prec = " ";
	$preprec = " ";
	$c = " ";
	if(substr($s, 0, 3) == "\xef\xbb\xbf") {
		$encoding = "utf-8";
		$start = 3;
	} else {
		$encoding = "iso-8859-1";
		$start = 0;
	}
	for($i=$start; $i<$limit && (($r2=="" && $r=="") || count($opentags)!=0); $i++) {
		echo "\r\t ".ceil($i*100/$limit)."%";
		if(strlen($r) > 10240) {
			$r2 .= $r;
			$r = "";
		}
		$c = $s{$i};
		switch($state) {
			case states_text:
				if($c == "<") {
					$name = "";
					$tagname = "";
					$attrname = "";
					$attrs = "";
					$attrnames = array();
					$state = states_tag;
					break;
				}
				if(!ctype_space($c) && count($opentags)==0) {
					$r .= "<html>";
					array_push($opentags, "html");
				}
				if(ctype_space($c) && count($opentags)==0) {
					break;
				}
				if($c == "&") {
					$name = "";
					$entvalue = 0;
					$prevstate = $state;
					$state = states_entity;
					break;
				}
				$r .= $c;
				break;
			case states_tag:
				if($c=="?" && $tagname=="") {
					$state = states_tillinst;
					break;
				}
				if($c=="!" && $tagname=="") {
					$state = states_specialtag;
					$prec = " ";
					break;
				}
				if($c=="/" && $name=="" && $tagname=="") {
					$state = states_endtag;
					$name = "";
					break;
				}
				if(ctype_space($c)) {
					if($name=="") {
						break;
					}
					if($tagname=="" && $name!="_") {
						$tagname = $name;
						$name = "";
						break;
					}
					if($attrname=="" && $name!="_") {
						$attrname = strtolower($name);
						$name = "";
						break;
					}
					break;
				}
				if($c=="=") {
					if($attrname=="" && $name!="_") {
						$attrname = strtolower($name);
						$name = "";
					}
					$state = states_tillquote;
					break;
				}
				if($c=="/" && ($tagname!="" || $name!="")) {
					if($tagname=="") {
						$tagname = $name;
					}
					$tagname = strtolower($tagname);
					if($tagname!="html" && count($opentags)==0) {
						$r .= "<html>";
						array_push($opentags, "html");
					}
					if(in_array($tagname, $autoclosekeys) && count($opentags) > 0) {
						$prevtag = $opentags[count($opentags)-1];
						if(in_array($prevtag, $autoclosetags[$tagname])) {
							array_pop($opentags);
							$r .= "</".$prevtag.">";
						}
					}
					$r .= "<".$tagname.$attrs."/>";
					$state = states_tillgt;
					break;
				}
				if($c==">") {
					if($tagname=="" && $name!="") {
						$tagname = $name;
					}
					if($tagname!="") {
						$tagname = strtolower($tagname);
						if($tagname!="html" && count($opentags)==0) {
							$r .= "<html>";
							array_push($opentags, "html");
						}
						if(in_array($tagname, $autoclosekeys) && count($opentags) > 0) {
							$prevtag = $opentags[count($opentags)-1];
							if(in_array($prevtag, $autoclosetags[$tagname])) {
								array_pop($opentags);
								$r .= "</".$prevtag.">";
							}
						}
						if(in_array($tagname, $emptytags)) {
							$r .= "<".$tagname.$attrs."/>";
						} else {
							array_push($opentags, $tagname);
							$r .= "<".$tagname.$attrs.">";
							if($tagname=="script") {
								$r .= "<![CDATA[";
								array_pop($opentags);
								$state = states_script;
								break;
							}
						}
						$state = states_text;
						break;
					}
				}
				if($attrname!="") {
					$attrs .= " ".$attrname."=\"".$attrname."\"";
					$attrname = "";
				}
				$name .= (ctype_alnum($c) && $name!="") || ctype_alpha($c) ? $c : ($name=="" ? "_" : ($c=="-" ? "-" : ($name != "_" ? "_" : "")));
				break;
			case states_endtag:
				if($c==">") {
					$name = strtolower($name);
					if(in_array($name, $opentags)) {
						while(($prevtag = array_pop($opentags)) != $name) {
							$r .= "</".$prevtag.">";
						}
						$r .= "</".$name.">";
					} else {
						if($name!="html" && count($opentags)==0) {
							$r .= "<html>";
							array_push($opentags, "html");
						}
					}
					$state = states_text;
					break;
				}
				if(ctype_space($c)) {
					break;
				}
				$name .= ctype_alnum($c) ? $c : ($name != "_" ? "_" : "");
				break;
			case states_attrtext:
				if($c==$attrdelim || (ctype_space($c) && $attrdelim==" ")) {
					if(!in_array($attrname, $attrnames)) {
						array_push($attrnames, $attrname);
						$attrs .= " ".$attrname."=\"".$attrvalue."\"";
					}
					$attrname = "";
					$state = states_tag;
					break;
				}
				if($attrdelim==" " && ($c=="/" || $c==">")) {
					$tagname = strtolower($tagname);
					if($tagname!="html" && count($opentags)==0) {
						$r .= "<html>";
						array_push($opentags, "html");
					}
					if(in_array($tagname, $autoclosekeys) && count($opentags) > 0) {
						$prevtag = $opentags[count($opentags)-1];
						if(in_array($prevtag, $autoclosetags[$tagname])) {
							array_pop($opentags);
							$r .= "</".$prevtag.">";
						}
					}
					if(!in_array($attrname, $attrnames)) {
						array_push($attrnames, $attrname);
						$attrs .= " ".$attrname."=\"".$attrvalue."\"";
					}
					$attrname = "";
					if($c=="/") {
						$r .= "<".$tagname.$attrs."/>";
						$state = states_tillgt;
						break;
					}
					if($c==">") {
						if(in_array($tagname, $emptytags)) {
							$r .= "<".$tagname.$attrs."/>";
							$state = states_text;
							break;
						} else {
							array_push($opentags, $tagname);
							$r .= "<".$tagname.$attrs.">";
							if($tagname=="script") {
								$r .= "<![CDATA[";
								array_pop($opentags);
								$prec = " ";
								$preprec = " ";
								$state = states_script;
								break;
							}
							$state = states_text;
							break;
						}
					}
				}
				if($c=="&") {
					$name = "";
					$entvalue = 0;
					$prevstate = $state;
					$state = states_entity;
					break;
				}
				$attrvalue .= $c=="\"" ? "&quot;" : ($c == "'" ? "&apos;" : $c);
				break;
			case states_script:
				if($c=="/" && $prec=="<") {
					$state = states_endscript;
					$name = "";
					break;
				}
				if($c=="[" && $prec=="!" && $preprec=="<") {
					$state = states_skipcdata;
					$name = "<![";
					break;
				}
				if($c==">" && $prec=="]" && $preprec=="]") {
					$c = $r{strlen($r)-3};
					$r = substr($r, 0, strlen($r)-4);
				}
				$r .= $c;
				$preprec = $prec;
				$prec = $c;
				break;
			case states_endscript:
				if($c==">" && strtolower($name)=="script") {
					$r = substr($r, 0, strlen($r)-1);
					$r .= "]]></script>";
					$state = states_text;
					break;
				}
				$name .= $c;
				if(substr("script", 0, strlen($name)) != strtolower($name)) {
					$r .= $name;
					$state = states_script;
				}
				break;
			case states_specialtag:
				if($c!="-") {
					$state = states_tillgt;
					break;
				}
				if($prec=="-") {
					$state = states_comment;
					$preprec = " ";
					break;
				}
				$prec = $c;
				break;
			case states_comment:
				if($c==">" && $prec=="-" && $preprec=="-") {
					$state = states_text;
					break;
				}
				$preprec = $prec;
				$prec = $c;
				break;
			case states_skipcdata:
				if($name=="<![CDATA[") {
					$state = states_script;
					break;
				}
				$name .= $c;
				if(substr("<![CDATA[", 0, strlen($name)) != $name) {
					$r .= $name;
					$state = states_script;
				}
				break;
			case states_entity:
				if($c=="#") {
					$state = states_numericentity;
					break;
				}
				$name .= $c;
				$state = states_namedentity;
				break;
			case states_numericentity:
				if($c=="x" || $c=="X") {
					$state = states_hexaentity;
					break;
				}
				if($c==";") {
					$ent = "&#".$entvalue.";";
					if($prevstate==states_text) {
						$r .= $ent;
					} else {
						$attrvalue .= $ent;
					}
					$state = $prevstate;
					break;
				}
				$entvalue = $entvalue * 10 + ord($c) - ord("0");
				break;
			case states_hexaentity:
				if($c==";") {
					$ent = "&#".$entvalue.";";
					if($prevstate==states_text) {
						$r .= $ent;
					} else {
						$attrvalue .= $ent;
					}
					$state = $prevstate;
					break;
				}
				$entvalue = $entvalue * 16 + (ctype_digit($c) ? ord($c)-ord("0") : ord(strtoupper($c)) - ord("A"));
				break;
			case states_namedentity:
				if($c==";") {
					$name = strtolower($name);
					if($name=="amp" || $name=="lt" || $name=="gt" || $name=="quot" || $name=="apos") {
						$ent = "&".$name.";";
						$name = "";
						if($prevstate==states_text) {
							$r .= $ent;
						} else {
							$attrvalue .= $ent;
						}
						$state = $prevstate;
						break;
					}
					if(in_array($name, array_keys($namedentities))) {
						$entvalue = $namedentities[$name];
					}
					if ($replace_entities) {
						$ent = ' ';
					} else {
						$ent = "&#".$entvalue.";";
					}
					$name = "";
					if($prevstate==states_text) {
						$r .= $ent;
					} else {
						$attrvalue .= $ent;
					}
					$state = $prevstate;
					break;
				}
				if(!ctype_alnum($c) || strlen($name) > 6) {
					$ent = "&amp;".$name;
					$name = "";
					if($prevstate==states_text) {
						$r .= $ent;
					} else {
						$attrvalue .= $ent;
					}
					$state = $prevstate;
					$i--;
					break;
				}
				$name .= $c;
				break;
			case states_tillinst:
				if($c=="?") {
					$state = states_andgt;
				}
				break;
			case states_andgt:
				if($c==">") {
					$state = states_text;
					break;
				}
				$state = states_tillinst;
				break;
			case states_tillgt:
				if($c==">") {
					$state = states_text;
				}
				break;
			case states_tillquote:
				if(ctype_space($c)) {
					break;
				}
				if($c=="\"" || $c=="'") {
					$attrdelim = $c;
					$attrvalue = "";
					$state = states_attrtext;
					break;
				}
				if($c=="/" || $c==">") {
					$attrs .= " ".$attrname."=\"".$attrname."\"";
				}
				if($c=="/") {
					$r .= "<".strtolower($tagname).$attrs."/>";
					$state = states_tillgt;
					break;
				}
				if($c==">") {
					$tagname = $tagname.ToLower();
					if($tagname!="html" && count($opentags)==0) {
						$r .= "<html>";
						array_push($opentags, "html");
					}
					if(in_array($tagname, $autoclosekeys) && count($opentags) > 0) {
						$prevtag = $opentags[count($opentags)-1];
						if(in_array($prevtag, $autoclosetags[$tagname])) {
							array_pop($opentags);
							$r .= "</".$prevtag.">";
						}
					}
					if(in_array($tagname, $emptytags)) {
						$r .= "<".$tagname.$attrs."/>";
						$state = states_text;
						break;
					} else {
						array_push($opentags, $tagname);
						$r .= "<".$tagname.$attrs.">";
						if($tagname=="script") {
							$r .= "<![CDATA[";
							array_pop($opentags);
							$state = states_script;
							break;
						}
					}
				}
				$attrdelim = " ";
				$attrvalue = $c;
				$state = states_attrtext;
				break;
		}
	}
	while(count($opentags) != 0) {
		$r .= "</".array_pop($opentags).">";
	}
	$r2 .= $r;
	return "<?xml version=\"1.0\" encoding=\"".$encoding."\"?>\n".$r2;
}
?>
